# E2EDrivingAgent PPO Phase K: Dense Urban (curved roads + intersections + signals)
# Strategy: WARM START from J v5 5M, add road_curvature curriculum
#
# Phase J v5 post-mortem:
#   - Full signal compliance achieved (5/5 green_ratio, peak +605.7)
#   - Agent handles: Y-junction + signals + 3 NPCs + 2 lanes
#   - Missing: road curvature (mutually exclusive with intersection in old code)
#
# Phase K code changes:
#   - WaypointManager: CollectCurvedIntersectionPositions added
#     Curved approach -> straightening zone -> intersection turn -> exit
#   - DrivingSceneManager: Always set curvature fields, updated scene validation
#   - PhaseSceneCreator: PhaseK_DenseUrban scene with curves + intersection
#
# Curriculum strategy:
#   - Single param: road_curvature (P-022 compliant)
#   - Start at curvature=0 (identical to J v5 conditions for warm-up)
#   - Gradually increase: 0 -> 0.3 -> 0.5
#   - All other params locked at J v5 final values
#   - Thresholds conservative: J v5 final was +537, curves will compress reward
#
# IMPORTANT: Requires PhaseK build (Builds/PhaseK/PhaseK.exe) with K code changes.
#
# P-018 compliance: Single-param curriculum, threaded=false
# P-019 compliance: No Unicode special characters
# P-022: Single-param curriculum avoids ordering issues
# P-023: Conservative thresholds accounting for curvature reward compression
# P-024: Verify BehaviorType=Default before building
#
# Hardware: RTX 4090 (24GB VRAM) + 128GB RAM

behaviors:
  E2EDrivingAgent:
    trainer_type: ppo

    hyperparameters:
      batch_size: 4096
      buffer_size: 40960
      learning_rate: 1.5e-4
      beta: 5.0e-3
      epsilon: 0.2
      lambd: 0.95
      num_epoch: 5
      learning_rate_schedule: constant
      beta_schedule: constant
      epsilon_schedule: constant

    network_settings:
      normalize: false
      hidden_units: 512
      num_layers: 3

    reward_signals:
      extrinsic:
        gamma: 0.99
        strength: 1.0

    init_path: results/phase-J-v5/E2EDrivingAgent/E2EDrivingAgent-5000148.pt
    max_steps: 5000000
    time_horizon: 256
    summary_freq: 10000
    keep_checkpoints: 10
    checkpoint_interval: 500000
    threaded: false

environment_parameters:
  # =======================================================
  # ALL LOCKED (J v5 final values, no curriculum)
  # Y-Junction + signals ON + green_ratio 0.4 from step 0
  # =======================================================

  goal_distance:
    curriculum:
      - name: FullGoal
        value: 230.0

  num_lanes:
    curriculum:
      - name: TwoLanes
        value: 2.0

  center_line_enabled:
    curriculum:
      - name: CenterLineEnforced
        value: 1.0

  num_active_npcs:
    curriculum:
      - name: ThreeNPCs
        value: 3.0

  npc_speed_ratio:
    curriculum:
      - name: NormalNPCs
        value: 0.85

  npc_speed_variation:
    curriculum:
      - name: FullVariation
        value: 0.15

  turn_direction:
    curriculum:
      - name: RightTurn
        value: 2.0

  intersection_type:
    curriculum:
      - name: YJunction
        value: 3.0

  traffic_signal_enabled:
    curriculum:
      - name: SignalActive
        value: 1.0

  signal_green_ratio:
    curriculum:
      - name: HardGreen
        value: 0.4

  speed_zone_count:
    curriculum:
      - name: OneZone
        value: 1.0

  # Curve variation locked at 0.5 (no effect when curvature=0, active when >0)
  curve_direction_variation:
    curriculum:
      - name: RandomCurves
        value: 0.5

  # =======================================================
  # ONLY CURRICULUM: road_curvature
  # Single-param progression (P-022 compliant)
  #
  # J v5 baseline: reward +537 at curvature=0, green_ratio=0.4
  # Expected reward compression with curvature:
  #   curvature=0.0: ~530-540 (same as J v5)
  #   curvature=0.3: ~430-480 (curved approach adds difficulty)
  #   curvature=0.5: ~400-450 (harder curves before intersection)
  #
  # Thresholds set conservatively below expected plateaus
  # =======================================================

  road_curvature:
    curriculum:
      - name: NoCurve
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          signal_smoothing: true
          min_lesson_length: 3000
          threshold: 490.0
        value: 0.0
      - name: LightCurve
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          signal_smoothing: true
          min_lesson_length: 3000
          threshold: 430.0
        value: 0.3
      - name: MediumCurve
        value: 0.5

# =======================================================
# BUILD-BASED MULTI-ENV TRAINING
# IMPORTANT: Must rebuild PhaseK.exe with K code changes
# Pre-build checklist (P-024):
#   1. Open PhaseK_DenseUrban scene
#   2. Verify BehaviorType = Default (NOT InferenceOnly)
#   3. Build via Build > Build Phase K
# =======================================================

env_settings:
  env_path: Builds/PhaseK/PhaseK.exe
  num_envs: 3
  base_port: 5010
  timeout_wait: 600

engine_settings:
  width: 640
  height: 480
  quality_level: 1
  time_scale: 20
  target_frame_rate: -1
  capture_frame_rate: 60
  no_graphics: true

torch_settings:
  device: cuda
