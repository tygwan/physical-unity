# E2EDrivingAgent PPO Phase D-v2: Staggered Curriculum (254D)
# Strategy: Each parameter advances at a DIFFERENT threshold to prevent simultaneous transitions
# Usage: mlagents-learn python/configs/planning/vehicle_ppo_phase-D-v2.yaml --run-id=phase-D-v2
#
# Phase D v1 Failure: 3 params (npcs, zones, variation) all had threshold ~400,
#   so they advanced simultaneously at step 4.68M -> reward crashed +406 -> -4825
#
# Phase D v2 Fix: Staggered thresholds ensure ONE parameter advances at a time
#   Step ~2M:  reward hits 200 -> num_active_npcs 1->2 (FIRST, easiest impact)
#   Step ~4M:  reward recovers to 300 -> npc_speed_variation 0->0.3 (SECOND)
#   Step ~5.5M: reward recovers to 350 -> speed_zone_count 1->2, npc_speed_ratio 0.3->0.6, goal 80->150
#   Step ~7M:  reward recovers to 300 -> num_active_npcs 2->3
#   Step ~8.5M: reward recovers to 350 -> zones 2->4, ratio 0.6->0.9, goal 150->230
#   Step ~9M:  reward recovers to 300 -> num_active_npcs 3->4 (FINAL)
#
# 10M steps, no init_path (254D fresh start), checkpoint every 500K

behaviors:
  E2EDrivingAgent:
    trainer_type: ppo

    hyperparameters:
      batch_size: 4096
      buffer_size: 40960
      learning_rate: 3.0e-4
      beta: 5.0e-3
      epsilon: 0.2
      lambd: 0.95
      num_epoch: 5
      learning_rate_schedule: linear

    network_settings:
      normalize: false
      hidden_units: 512
      num_layers: 3

    reward_signals:
      extrinsic:
        gamma: 0.99
        strength: 1.0

    max_steps: 10000000
    time_horizon: 256
    summary_freq: 10000
    checkpoint_interval: 500000
    keep_checkpoints: 10
    threaded: false

environment_parameters:
  # === num_active_npcs: Advances FIRST (threshold 200) and THIRD (threshold 300) ===
  # This is the primary difficulty driver, so it advances at the lowest thresholds.
  # Lesson transitions: 1->2 at reward 200, 2->3 at 300, 3->4 at 300
  num_active_npcs:
    curriculum:
      - name: Stage1_OneNPC
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 500
          threshold: 200.0
          signal_smoothing: true
        value: 1.0
      - name: Stage2_TwoNPCs
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 500
          threshold: 300.0
          signal_smoothing: true
        value: 2.0
      - name: Stage3_ThreeNPCs
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 500
          threshold: 300.0
          signal_smoothing: true
        value: 3.0
      - name: Stage4_FourNPCs
        value: 4.0

  # === npc_speed_variation: Advances SECOND (threshold 300) ===
  # After adapting to 2 NPCs, add speed randomness.
  # Higher threshold than npcs (300 vs 200) ensures npcs advance first.
  npc_speed_variation:
    curriculum:
      - name: Stage1_Uniform
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 500
          threshold: 300.0
          signal_smoothing: true
        value: 0.0
      - name: Stage2_HighVariation
        value: 0.3

  # === npc_speed_ratio: Advances LATER (threshold 350) ===
  # Speed ratio increase is moderate difficulty. 350 ensures it comes after NPCs and variation.
  npc_speed_ratio:
    curriculum:
      - name: Stage1_SlowNPCs
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 500
          threshold: 350.0
          signal_smoothing: true
        value: 0.3
      - name: Stage2_MediumNPCs
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 500
          threshold: 350.0
          signal_smoothing: true
        value: 0.6
      - name: Stage3_FastNPCs
        value: 0.9

  # === goal_distance: Advances LATER (threshold 350) ===
  # Longer goals are a moderate challenge. Advances alongside speed_ratio.
  goal_distance:
    curriculum:
      - name: Stage1_ShortGoal
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 500
          threshold: 350.0
          signal_smoothing: true
        value: 80.0
      - name: Stage2_MediumGoal
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 500
          threshold: 350.0
          signal_smoothing: true
        value: 150.0
      - name: Stage3_LongGoal
        value: 230.0

  # === speed_zone_count: Advances LATER (threshold 350) ===
  # Multiple zones require speed adaptation. Groups with ratio and goal.
  speed_zone_count:
    curriculum:
      - name: Stage1_SingleZone
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 500
          threshold: 350.0
          signal_smoothing: true
        value: 1.0
      - name: Stage2_TwoZones
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 500
          threshold: 350.0
          signal_smoothing: true
        value: 2.0
      - name: Stage3_FourZones
        value: 4.0

env_settings:
  env_path: null
  num_envs: 1
  base_port: 5004
  timeout_wait: 600

checkpoint_settings:
  run_id: phase-D-v2
  resume: false
  force: false

engine_settings:
  width: 640
  height: 480
  quality_level: 1
  time_scale: 20
  target_frame_rate: -1
  capture_frame_rate: 60
  no_graphics: false

torch_settings:
  device: cuda
