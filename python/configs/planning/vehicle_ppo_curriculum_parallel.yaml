# E2EDrivingAgent PPO + Curriculum (16x Parallel Training Areas)
# Stage 4+5: Speed Policy + Traffic Interaction + Overtaking
# Usage: mlagents-learn python/configs/planning/vehicle_ppo_curriculum_parallel.yaml --run-id=curriculum_v11_overtake --initialize-from=curriculum_v10g_lanekeep
#
# Optimized for 16 Training Areas in single Unity instance
# - batch_size/buffer_size scaled for 16 concurrent agents
# - Curriculum: NPC count + Goal distance + Speed zone + NPC speed variation
# - Observation space: 242D (238D base + 4D speed_info)
# - v11 NEW: Overtaking reward state machine (Approaching -> Beside -> Completed)
# - v11 NEW: SphereCast lead detection (radius 3m, catches offset NPCs)
# - v11 NEW: overtakePassBonus (+3.0 one-time) for completing pass
# - v11 NEW: overtakeSpeedBonus (+0.15/step) for maintaining speed beside NPC
# - v11 NEW: Lane keeping lateral penalty suspended during overtaking
# - v11 NEW: Following bonus only when NPC > 70% of speed limit
# - v10g BASE: Lane keeping (0.02), NPC lateral offset, 3-strike collision
# - Resume from v10g ~5M checkpoint

behaviors:
  E2EDrivingAgent:
    trainer_type: ppo

    hyperparameters:
      batch_size: 4096
      buffer_size: 40960
      learning_rate: 3.0e-4
      beta: 5.0e-3
      epsilon: 0.2
      lambd: 0.95
      num_epoch: 5
      learning_rate_schedule: linear

    network_settings:
      normalize: false
      hidden_units: 512
      num_layers: 3

    reward_signals:
      extrinsic:
        gamma: 0.99
        strength: 1.0

    max_steps: 8000000
    time_horizon: 256
    summary_freq: 10000
    threaded: false

# Curriculum: environment parameters controlled by training progress
environment_parameters:
  num_active_npcs:
    curriculum:
      - name: Lesson0_NoTraffic
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 500
          threshold: 30.0
          signal_smoothing: true
        value: 0.0
      - name: Lesson1_SingleNPC
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 800
          threshold: 25.0
          signal_smoothing: true
        value: 1.0
      - name: Lesson2_TwoNPCs
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 800
          threshold: 20.0
          signal_smoothing: true
        value: 2.0
      - name: Lesson3_FourNPCs
        value: 4.0

  goal_distance:
    curriculum:
      - name: ShortGoal
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 300
          threshold: 28.0
          signal_smoothing: true
        value: 50.0
      - name: MediumGoal
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 300
          threshold: 30.0
          signal_smoothing: true
        value: 100.0
      - name: LongGoal
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 300
          threshold: 32.0
          signal_smoothing: true
        value: 160.0
      - name: FullGoal
        value: 230.0

  speed_zone_count:
    curriculum:
      - name: SingleZone
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 300
          threshold: 28.0
          signal_smoothing: true
        value: 1.0
      - name: TwoZones
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 300
          threshold: 30.0
          signal_smoothing: true
        value: 2.0
      - name: ThreeZones
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 300
          threshold: 32.0
          signal_smoothing: true
        value: 3.0
      - name: FourZones
        value: 4.0

  npc_speed_variation:
    curriculum:
      - name: UniformSpeed
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 300
          threshold: 28.0
          signal_smoothing: true
        value: 0.0
      - name: SlightVariation
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 300
          threshold: 30.0
          signal_smoothing: true
        value: 0.1
      - name: ModerateVariation
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 300
          threshold: 32.0
          signal_smoothing: true
        value: 0.2
      - name: HighVariation
        value: 0.3

# Environment settings (single Unity instance with 16 Training Areas)
env_settings:
  env_path: null
  num_envs: 1
  base_port: 5004
  timeout_wait: 600

# Checkpoint settings
checkpoint_settings:
  run_id: curriculum_v11_overtake
  resume: false
  force: false

# Engine configuration
engine_settings:
  width: 640
  height: 480
  quality_level: 1
  time_scale: 20
  target_frame_rate: -1
  capture_frame_rate: 60
  no_graphics: false

torch_settings:
  device: cuda
