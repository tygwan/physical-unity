# E2EDrivingAgent PPO v12 Phase E: Curved Roads + Non-standard Angles
# Strategy: Initialize from Phase D, add road curvature curriculum
# Usage: mlagents-learn python/configs/planning/vehicle_ppo_phase-E.yaml --run-id=phase-E
#
# v12 Phase E Design:
# - 254D observation (same as Phase D)
# - Road curvature curriculum: straight -> gentle curves -> sharp curves
# - Initialize from Phase D checkpoint
# - Expected: 4-6M steps
#
# Unity Environment Requirements:
# - WaypointManager: Generate curved paths based on 'road_curvature' parameter
# - E2EDrivingAgent: Add curvature observation (optional, Phase F)
# - DrivingSceneManager: Read 'road_curvature' from environment_parameters

behaviors:
  E2EDrivingAgent:
    trainer_type: ppo

    # Initialize from Phase D best checkpoint
    init_path: results/phase-D/E2EDrivingAgent.onnx

    hyperparameters:
      batch_size: 4096
      buffer_size: 40960
      learning_rate: 1.5e-4        # Reduced for fine-tuning
      beta: 5.0e-3
      epsilon: 0.2
      lambd: 0.95
      num_epoch: 5
      learning_rate_schedule: linear

    network_settings:
      normalize: false
      hidden_units: 512
      num_layers: 3

    reward_signals:
      extrinsic:
        gamma: 0.99
        strength: 1.0

    max_steps: 6000000
    time_horizon: 256
    summary_freq: 10000
    threaded: false

environment_parameters:
  # Road curvature curriculum: 0 = straight, 1.0 = max curvature
  # Curvature affects waypoint generation in WaypointManager
  road_curvature:
    curriculum:
      - name: Straight
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 500
          threshold: 300.0
          signal_smoothing: true
        value: 0.0
      - name: GentleCurves
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 500
          threshold: 250.0
          signal_smoothing: true
        value: 0.3
      - name: ModerateCurves
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 500
          threshold: 200.0
          signal_smoothing: true
        value: 0.6
      - name: SharpCurves
        value: 1.0

  # Curve angle variation (degrees from straight)
  # 0 = all curves same direction, 1.0 = random left/right
  curve_direction_variation:
    curriculum:
      - name: SingleDirection
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 400
          threshold: 250.0
          signal_smoothing: true
        value: 0.0
      - name: MixedDirections
        value: 1.0

  # NPC count (maintain Phase D capability)
  num_active_npcs:
    curriculum:
      - name: NoNPCs
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 400
          threshold: 350.0
          signal_smoothing: true
        value: 0.0
      - name: OneNPC
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 400
          threshold: 300.0
          signal_smoothing: true
        value: 1.0
      - name: TwoNPCs
        value: 2.0

  # NPC speed ratio (slower NPCs on curves for safety)
  npc_speed_ratio:
    curriculum:
      - name: SlowNPCs
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 300
          threshold: 300.0
          signal_smoothing: true
        value: 0.4
      - name: MediumNPCs
        value: 0.7

  # Goal distance (shorter for curved roads)
  goal_distance:
    curriculum:
      - name: ShortGoal
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 300
          threshold: 300.0
          signal_smoothing: true
        value: 100.0
      - name: MediumGoal
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 300
          threshold: 250.0
          signal_smoothing: true
        value: 150.0
      - name: LongGoal
        value: 200.0

  # Speed zones
  speed_zone_count:
    curriculum:
      - name: SingleZone
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 300
          threshold: 300.0
          signal_smoothing: true
        value: 1.0
      - name: TwoZones
        value: 2.0

  # NPC speed variation
  npc_speed_variation:
    curriculum:
      - name: Uniform
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 300
          threshold: 280.0
          signal_smoothing: true
        value: 0.0
      - name: Varied
        value: 0.2

env_settings:
  env_path: null
  num_envs: 1
  base_port: 5004
  timeout_wait: 600

checkpoint_settings:
  run_id: phase-E
  resume: false
  force: false

engine_settings:
  width: 640
  height: 480
  quality_level: 1
  time_scale: 20
  target_frame_rate: -1
  capture_frame_rate: 60
  no_graphics: false

torch_settings:
  device: cuda
