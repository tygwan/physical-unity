# Phase C: Multi-NPC Interaction & Advanced Decision-Making
#
# Based on Phase B v2 success (+877 reward, 3 NPCs)
# Objective: Scale to 5-8 NPCs with selective overtaking decisions

behaviors:
  E2EDrivingAgent:
    trainer_type: ppo

    # Hyperparameters: Same as Phase B v2 (proven stable)
    hyperparameters:
      batch_size: 4096
      buffer_size: 40960
      learning_rate: 3.0e-4
      beta: 5.0e-3
      epsilon: 0.2
      lambd: 0.95
      num_epoch: 5
      learning_rate_schedule: linear

    # Network: Same as Phase B v2
    network_settings:
      normalize: false
      hidden_units: 512
      num_layers: 3

    # Reward Signals
    reward_signals:
      extrinsic:
        gamma: 0.99
        strength: 1.0

    # Training Duration
    max_steps: 3600000
    time_horizon: 256
    summary_freq: 5000
    checkpoint_interval: 500000
    keep_checkpoints: 8
    threaded: false

    # INITIALIZATION: Phase B v2 checkpoint
    init_path: results/phase-B-decision-v2/E2EDrivingAgent/E2EDrivingAgent-3500347.pt

environment_parameters:

  # NPC COUNT PROGRESSION: 3->4->5->6->8
  num_active_npcs:
    curriculum:
      - name: Stage0_Consolidation
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 200
          threshold: 800.0
          signal_smoothing: true
        value: 3.0

      - name: Stage1_GradualScaling
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 200
          threshold: 950.0
          signal_smoothing: true
        value: 4.0

      - name: Stage2_MediumComplexity
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 200
          threshold: 1100.0
          signal_smoothing: true
        value: 5.0

      - name: Stage3_HighComplexity
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 200
          threshold: 1250.0
          signal_smoothing: true
        value: 6.0

      - name: Stage4_FullChallenge
        value: 8.0

  # NPC SPEED RATIO: 0.4 -> 0.9 (realistic range)
  npc_speed_ratio:
    curriculum:
      - name: VerySlow
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 200
          threshold: 950.0
          signal_smoothing: true
        value: 0.4

      - name: Slow
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 200
          threshold: 1100.0
          signal_smoothing: true
        value: 0.55

      - name: Medium
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 200
          threshold: 1250.0
          signal_smoothing: true
        value: 0.7

      - name: MediumFast
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 200
          threshold: 1350.0
          signal_smoothing: true
        value: 0.85

      - name: Mixed
        value: 0.9

  # GOAL DISTANCE: 100 -> 300m
  goal_distance:
    curriculum:
      - name: ShortGoal
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 200
          threshold: 950.0
          signal_smoothing: true
        value: 100.0

      - name: MediumGoal
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 200
          threshold: 1100.0
          signal_smoothing: true
        value: 150.0

      - name: LongGoal
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 200
          threshold: 1250.0
          signal_smoothing: true
        value: 200.0

      - name: VeryLongGoal
        value: 300.0

  # SPEED ZONE COUNT: 1 -> 2
  speed_zone_count:
    curriculum:
      - name: SingleZone
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 200
          threshold: 1100.0
          signal_smoothing: true
        value: 1.0

      - name: MultiZone
        value: 2.0

  # NPC SPEED VARIATION: 0 -> 0.5
  npc_speed_variation:
    curriculum:
      - name: Uniform
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 200
          threshold: 1100.0
          signal_smoothing: true
        value: 0.0

      - name: LowVariation
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 200
          threshold: 1250.0
          signal_smoothing: true
        value: 0.15

      - name: MediumVariation
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 200
          threshold: 1350.0
          signal_smoothing: true
        value: 0.3

      - name: HighVariation
        value: 0.5

  # OVERTAKING AGGRESSIVENESS: NEW parameter for Phase C
  overtaking_aggressiveness:
    curriculum:
      - name: Conservative
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 200
          threshold: 1000.0
          signal_smoothing: true
        value: 0.5

      - name: Moderate
        completion_criteria:
          measure: reward
          behavior: E2EDrivingAgent
          min_lesson_length: 200
          threshold: 1150.0
          signal_smoothing: true
        value: 0.75

      - name: Aggressive
        value: 1.0

# Environment settings
env_settings:
  env_path: null
  num_envs: 1
  base_port: 5004
  timeout_wait: 600

checkpoint_settings:
  run_id: phase-C-multi-npc
  resume: false
  force: false

engine_settings:
  width: 640
  height: 480
  quality_level: 1
  time_scale: 20
  target_frame_rate: -1
  capture_frame_rate: 60
  no_graphics: false

torch_settings:
  device: cuda
