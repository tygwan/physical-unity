---
import { policyDiscoveries, sotifQuadrants, teslaGapAnalysis, resourceComparisons, references, referenceCategories } from '../data/phases';

const quadrantColors: Record<number, { bg: string; border: string; text: string; label: string }> = {
  1: { bg: 'bg-emerald-500/8', border: 'border-emerald-500/20', text: 'text-emerald-400', label: 'SAFE' },
  2: { bg: 'bg-rose-500/8', border: 'border-rose-500/20', text: 'text-rose-400', label: 'UNSAFE' },
  3: { bg: 'bg-red-500/8', border: 'border-red-500/20', text: 'text-red-400', label: 'UNSAFE' },
  4: { bg: 'bg-sky-500/8', border: 'border-sky-500/20', text: 'text-sky-400', label: 'SAFE' },
};

const gapColors: Record<string, string> = {
  CRITICAL: 'gap-critical',
  MAJOR: 'gap-major',
  MODERATE: 'gap-moderate',
  ACHIEVED: 'gap-achieved',
};

const refCatColors: Record<string, string> = {
  standard: 'border-violet-500/20 bg-violet-500/5',
  academic: 'border-sky-500/20 bg-sky-500/5',
  control: 'border-emerald-500/20 bg-emerald-500/5',
  curriculum: 'border-amber-500/20 bg-amber-500/5',
  analysis: 'border-slate-500/20 bg-slate-500/5',
};

const refLabelColors: Record<string, string> = {
  standard: 'text-violet-400',
  academic: 'text-sky-400',
  control: 'text-emerald-400',
  curriculum: 'text-amber-400',
  analysis: 'text-slate-400',
};
---

<section id="research" class="py-24">
  <div class="mx-auto max-w-7xl px-6">

    <h2 class="section-heading">Research</h2>
    <p class="section-sub">
      Safety frameworks, competitive analysis, and policy discoveries from iterative training
    </p>

    <!-- ========== SOTIF 4-Quadrant Model ========== -->
    <div class="mt-16">
      <h3 class="text-xl font-bold text-white flex items-center gap-2">
        <span class="flex h-7 w-7 items-center justify-center rounded-lg bg-violet-500/15 text-violet-400 text-xs font-mono">S</span>
        SOTIF Framework (ISO 21448)
      </h3>
      <p class="mt-2 text-sm text-slate-400 max-w-2xl">
        ISO 21448 defines Safety of the Intended Functionality -- addressing risks from functional limitations rather than system faults.
        The 4-quadrant model classifies scenarios by knowledge and safety status.
      </p>

      <!-- Quadrant grid -->
      <div class="mt-8 grid grid-cols-1 sm:grid-cols-2 gap-4 max-w-3xl">
        {sotifQuadrants.map((q) => {
          const c = quadrantColors[q.id];
          return (
            <div class={`rounded-xl border ${c.border} ${c.bg} p-5 transition hover:bg-opacity-20`}>
              <div class="flex items-center justify-between mb-3">
                <span class={`text-xs font-bold uppercase tracking-wider ${c.text}`}>
                  Q{q.id}: {q.label}
                </span>
                <span class="text-xs text-slate-500">
                  {q.id <= 2 ? 'KNOWN' : 'UNKNOWN'}
                </span>
              </div>
              <p class="text-xs text-slate-400 leading-relaxed">{q.description}</p>
              <div class="mt-3 flex flex-wrap gap-1.5">
                {q.phases.map((p) => (
                  <span class="rounded bg-slate-800/80 px-2 py-0.5 text-xs text-slate-400">{p}</span>
                ))}
              </div>
            </div>
          );
        })}
      </div>
      <p class="mt-4 text-xs text-slate-500 max-w-2xl">
        Goal: shrink Quadrant 2 and 3 (unsafe areas) while expanding Quadrant 1 (known safe).
        Each training phase systematically moves scenarios from Unknown to Known.
      </p>
    </div>

    <!-- ========== Tesla FSD Gap Analysis ========== -->
    <div class="mt-20">
      <h3 class="text-xl font-bold text-white flex items-center gap-2">
        <span class="flex h-7 w-7 items-center justify-center rounded-lg bg-rose-500/15 text-rose-400 text-xs font-mono">T</span>
        Tesla FSD Gap Analysis
      </h3>
      <p class="mt-2 text-sm text-slate-400 max-w-2xl">
        Component-by-component comparison against Tesla FSD 12/13 architecture.
        This project is a research platform, not a commercial product -- the gap is intentional and informative.
      </p>

      <!-- Resource comparison -->
      <div class="mt-8 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3">
        {resourceComparisons.map((r) => (
          <div class="rounded-xl border border-slate-800/80 bg-slate-900/40 p-4 text-center">
            <div class="text-xs text-slate-500 uppercase tracking-wider">{r.metric}</div>
            <div class="mt-2 text-xs font-mono text-rose-400 leading-tight">{r.tesla}</div>
            <div class="my-1.5 text-slate-700">vs</div>
            <div class="text-xs font-mono text-sky-400 leading-tight">{r.thisProject}</div>
            <div class="mt-2 text-[10px] text-slate-600 font-mono">{r.ratio}</div>
          </div>
        ))}
      </div>

      <!-- Gap table -->
      <div class="mt-8 overflow-x-auto">
        <table class="w-full text-sm text-left">
          <thead>
            <tr class="border-b border-slate-800">
              <th class="py-3 pr-4 text-xs font-semibold text-slate-400 uppercase tracking-wider">Component</th>
              <th class="py-3 pr-4 text-xs font-semibold text-slate-400 uppercase tracking-wider">Tesla FSD</th>
              <th class="py-3 pr-4 text-xs font-semibold text-slate-400 uppercase tracking-wider">This Project</th>
              <th class="py-3 pr-4 text-xs font-semibold text-slate-400 uppercase tracking-wider">Gap</th>
              <th class="py-3 text-xs font-semibold text-slate-400 uppercase tracking-wider">Feasibility</th>
            </tr>
          </thead>
          <tbody>
            {teslaGapAnalysis.map((item) => (
              <tr class="border-b border-slate-800/50 hover:bg-slate-800/20 transition">
                <td class="py-3 pr-4 font-medium text-white text-sm">{item.component}</td>
                <td class="py-3 pr-4 text-xs text-slate-400">{item.teslaFsd}</td>
                <td class="py-3 pr-4 text-xs text-slate-400">{item.thisProject}</td>
                <td class="py-3 pr-4">
                  <span class={`inline-block rounded-full border px-2.5 py-0.5 text-xs font-medium ${gapColors[item.gapLevel]}`}>
                    {item.gapLevel}
                  </span>
                </td>
                <td class="py-3 text-xs text-slate-500">{item.feasibility}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      <div class="mt-6 rounded-xl border border-slate-800/60 bg-slate-900/40 p-5">
        <p class="text-sm text-slate-400 leading-relaxed">
          <span class="text-slate-200 font-medium">Key Insight:</span> Tesla FSD is a commercial product backed by 4M+ fleet vehicles and Dojo supercomputer (1.1 ExaFLOPS).
          This project operates on a single RTX 4090 (82.6 TFLOPS) -- a 13-million-fold compute gap.
          The value lies in algorithm validation, not scale replication.
          Vehicle Control is the only component at parity, achieved through direct RL policy output.
        </p>
      </div>
    </div>

    <!-- ========== Policy Discovery Timeline ========== -->
    <div class="mt-20">
      <h3 class="text-xl font-bold text-white flex items-center gap-2">
        <span class="flex h-7 w-7 items-center justify-center rounded-lg bg-amber-500/15 text-amber-400 text-xs font-mono">P</span>
        Policy Discovery Log
      </h3>
      <p class="mt-2 text-sm text-slate-400 max-w-2xl">
        Design principles discovered through trial-and-error training.
        Each failure produced actionable policies that converge with established standards.
      </p>

      <div class="mt-8 space-y-4">
        {policyDiscoveries.map((p) => {
          const statusColor = p.status === 'verified' ? 'text-emerald-400 bg-emerald-500/10 border-emerald-500/20'
            : p.status === 'in_progress' ? 'text-amber-400 bg-amber-500/10 border-amber-500/20'
            : 'text-slate-400 bg-slate-500/10 border-slate-500/20';
          return (
            <div class="rounded-xl border border-slate-800/80 bg-slate-900/40 p-5 transition hover:border-slate-700 card-glow">
              <div class="flex flex-wrap items-center gap-3 mb-3">
                <span class="text-xs font-mono font-bold text-sky-400 bg-sky-500/10 border border-sky-500/20 rounded px-2 py-0.5">{p.id}</span>
                <span class="text-sm font-semibold text-white">{p.name}</span>
                <span class={`text-xs font-medium rounded-full border px-2.5 py-0.5 ${statusColor}`}>
                  {p.status === 'verified' ? 'VERIFIED' : p.status === 'in_progress' ? 'IN PROGRESS' : 'PLANNED'}
                </span>
                <span class="ml-auto text-xs text-slate-500">{p.sourcePhase}</span>
              </div>
              <p class="text-sm text-slate-400 leading-relaxed">{p.description}</p>
              <div class="mt-3 grid gap-3 sm:grid-cols-2">
                <div class="rounded-lg border border-rose-500/10 bg-rose-500/5 p-3">
                  <div class="text-xs font-medium text-rose-400 mb-1">FAIL</div>
                  <p class="text-xs text-slate-400">{p.failContext}</p>
                </div>
                <div class="rounded-lg border border-emerald-500/10 bg-emerald-500/5 p-3">
                  <div class="text-xs font-medium text-emerald-400 mb-1">FIX</div>
                  <p class="text-xs text-slate-400">{p.fixContext}</p>
                </div>
              </div>
              <div class="mt-3 text-xs text-slate-500">
                Matching Standard: <span class="text-slate-400">{p.matchingStandard}</span>
              </div>
            </div>
          );
        })}
      </div>
    </div>

    <!-- ========== References & Academic Research ========== -->
    <div class="mt-20">
      <h3 class="text-xl font-bold text-white flex items-center gap-2">
        <span class="flex h-7 w-7 items-center justify-center rounded-lg bg-cyan-500/15 text-cyan-400 text-xs font-mono">R</span>
        References &amp; Academic Research
      </h3>
      <p class="mt-2 text-sm text-slate-400 max-w-2xl">
        Standards, papers, and technical analyses that inform the training curriculum, reward design, and safety validation framework.
      </p>

      <!-- Category tabs -->
      <div class="mt-8 flex flex-wrap gap-2">
        {referenceCategories.map((cat) => {
          const catRefs = references.filter((r) => r.category === cat.key);
          return (
            <span class="rounded-full border border-slate-700 bg-slate-800/60 px-3 py-1 text-xs text-slate-300">
              <span class="font-mono text-cyan-400 mr-1">{cat.icon}</span>
              {cat.label} <span class="text-slate-500 ml-1">({catRefs.length})</span>
            </span>
          );
        })}
      </div>

      <!-- Reference list grouped by category -->
      {referenceCategories.map((cat) => {
        const catRefs = references.filter((r) => r.category === cat.key);
        const catColors = refCatColors;
        const labelColors = refLabelColors;
        return (
          <div class="mt-8">
            <h4 class={`text-sm font-semibold ${labelColors[cat.key]} uppercase tracking-wider mb-4`}>
              {cat.label}
            </h4>
            <div class="space-y-3">
              {catRefs.map((ref) => (
                <div class={`rounded-xl border ${catColors[cat.key]} p-4 transition hover:border-slate-600`}>
                  <div class="flex items-start justify-between gap-4">
                    <div class="flex-1 min-w-0">
                      <a href={ref.url} target="_blank" rel="noopener noreferrer"
                         class="text-sm font-medium text-white hover:text-cyan-400 transition leading-snug">
                        {ref.title}
                      </a>
                      <div class="mt-1 flex flex-wrap items-center gap-2 text-xs text-slate-500">
                        {ref.venue && <span>{ref.venue}</span>}
                        <span class="text-slate-700">&middot;</span>
                        <span>{ref.year}</span>
                      </div>
                    </div>
                    <a href={ref.url} target="_blank" rel="noopener noreferrer"
                       class="shrink-0 rounded-lg border border-slate-700 bg-slate-800/80 px-2.5 py-1 text-xs text-slate-400 hover:text-white hover:border-slate-500 transition">
                      Open &rarr;
                    </a>
                  </div>
                  <p class="mt-2 text-xs text-slate-400 leading-relaxed">{ref.relevance}</p>
                </div>
              ))}
            </div>
          </div>
        );
      })}

      <div class="mt-8 rounded-xl border border-cyan-500/20 bg-cyan-500/5 p-5">
        <p class="text-sm text-slate-400 leading-relaxed">
          <span class="text-slate-200 font-medium">Convergence Insight:</span> Our empirical policies (P-001 through P-011) discovered through trial-and-error training
          independently converge with established international safety standards.
          P-002 (Staggered Curriculum) maps to SOTIF's incremental complexity principle.
          P-005/P-006 (planned) directly implement UN R157/R171 numerical limits.
          This convergence validates that RL-based policy learning naturally rediscovers safety engineering principles.
        </p>
      </div>
    </div>

  </div>
</section>
