---
import { policyDiscoveries } from '../data/phases';
import { getTranslations, type Lang } from '../i18n';

interface Props { lang?: Lang; }
const { lang = 'en' } = Astro.props;
const t = getTranslations(lang);

const worked = [
  { title: t.insights.denseReward, detail: t.insights.denseRewardDetail },
  { title: t.insights.curriculum, detail: t.insights.curriculumDetail },
  { title: t.insights.checkpoint, detail: t.insights.checkpointDetail },
  { title: t.insights.parallel, detail: t.insights.parallelDetail },
];

const failed = [
  { title: t.insights.curriculumShock, detail: t.insights.curriculumShockDetail, policy: 'P-002' },
  { title: t.insights.freshStart, detail: t.insights.freshStartDetail, policy: 'P-003' },
  { title: t.insights.excessivePenalty, detail: t.insights.excessivePenaltyDetail, policy: 'P-004' },
  { title: t.insights.obsDimChange, detail: t.insights.obsDimChangeDetail, policy: 'P-009' },
];

// Standards mapping
const standards = [
  { standard: t.insights.sotifStandard, desc: t.insights.sotifStandardDesc, accent: 'sky' },
  { standard: t.insights.unR171, desc: t.insights.unR171Desc, accent: 'violet' },
  { standard: t.insights.unR157, desc: t.insights.unR157Desc, accent: 'emerald' },
];

const accentColors: Record<string, string> = {
  sky:     'border-sky-500/15 bg-sky-500/5 text-sky-400',
  violet:  'border-violet-500/15 bg-violet-500/5 text-violet-400',
  emerald: 'border-emerald-500/15 bg-emerald-500/5 text-emerald-400',
};

// Convergence map: experiential discoveries -> standards
const convergences = [
  { policy: 'P-001', name: 'Variable Isolation', arrow: 'Controlled Experiment Design' },
  { policy: 'P-002', name: 'Staggered Curriculum', arrow: 'SOTIF Incremental Complexity' },
  { policy: 'P-003', name: 'Capability Checkpoint', arrow: 'Transfer Learning Best Practice' },
  { policy: 'P-004', name: 'Conservative Penalty', arrow: 'Reward Shaping Theory' },
  { policy: 'P-005', name: 'Lateral Accel Limit', arrow: 'UN R157 (lat_accel < 0.3g)' },
  { policy: 'P-006', name: 'TTC-Based Response', arrow: 'UN R171 (TTC 1.5-5.0s)' },
  { policy: 'P-007', name: 'Curvature Rate', arrow: 'SOTIF FI + UN R157 dk/ds' },
];
---

<section id="insights" class="py-24">
  <div class="mx-auto max-w-7xl px-6">

    <h2 class="section-heading">{t.insights.heading}</h2>
    <p class="section-sub">
      {t.insights.sub}
    </p>

    <!-- ========== What Worked / What Failed ========== -->
    <div class="mt-12 grid gap-8 lg:grid-cols-2">

      <!-- What worked -->
      <div>
        <h3 class="mb-5 flex items-center gap-2 text-lg font-semibold text-emerald-400">
          <span class="flex h-7 w-7 items-center justify-center rounded-lg bg-emerald-500/10 text-xs">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 13l4 4L19 7" /></svg>
          </span>
          {t.insights.whatWorked}
        </h3>
        <div class="space-y-3">
          {worked.map((item) => (
            <div class="rounded-xl border border-emerald-500/10 bg-emerald-500/5 p-4 transition hover:border-emerald-500/20 card-glow">
              <h4 class="font-semibold text-white text-sm">{item.title}</h4>
              <p class="mt-1 text-xs text-slate-400 leading-relaxed">{item.detail}</p>
            </div>
          ))}
        </div>
      </div>

      <!-- What failed -->
      <div>
        <h3 class="mb-5 flex items-center gap-2 text-lg font-semibold text-rose-400">
          <span class="flex h-7 w-7 items-center justify-center rounded-lg bg-rose-500/10 text-xs">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 6L6 18M6 6l12 12" /></svg>
          </span>
          {t.insights.whatFailed}
        </h3>
        <div class="space-y-3">
          {failed.map((item) => (
            <div class="rounded-xl border border-rose-500/10 bg-rose-500/5 p-4 transition hover:border-rose-500/20 card-glow">
              <div class="flex items-center justify-between mb-1">
                <h4 class="font-semibold text-white text-sm">{item.title}</h4>
                <span class="text-[10px] font-mono text-rose-400 bg-rose-500/10 border border-rose-500/20 rounded px-1.5 py-0.5">{item.policy}</span>
              </div>
              <p class="text-xs text-slate-400 leading-relaxed">{item.detail}</p>
            </div>
          ))}
        </div>
      </div>
    </div>

    <!-- ========== Standard Convergence Map ========== -->
    <div class="mt-16 rounded-2xl border border-slate-800/80 bg-slate-900/40 p-6 sm:p-8">
      <h3 class="text-lg font-semibold text-white mb-2">{t.insights.convergenceTitle}</h3>
      <p class="text-sm text-slate-400 mb-6">
        {t.insights.convergenceDesc}
      </p>
      <div class="space-y-2 font-mono text-sm">
        {convergences.map((c) => (
          <div class="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-0">
            <div class="flex items-center gap-2 sm:w-[45%]">
              <span class="text-xs text-sky-400 bg-sky-500/10 border border-sky-500/20 rounded px-1.5 py-0.5">{c.policy}</span>
              <span class="text-sm text-slate-300">{c.name}</span>
            </div>
            <div class="hidden sm:block text-slate-600 px-3 sm:w-[10%] text-center">&harr;</div>
            <div class="sm:w-[45%] text-sm text-amber-400">{c.arrow}</div>
          </div>
        ))}
      </div>
    </div>

    <!-- ========== Safety Standards ========== -->
    <div class="mt-12">
      <h3 class="text-lg font-semibold text-white mb-6">{t.insights.standardsTitle}</h3>
      <div class="grid gap-4 sm:grid-cols-3">
        {standards.map((s) => {
          const colors = accentColors[s.accent];
          return (
            <div class={`rounded-xl border p-5 ${colors}`}>
              <div class="text-sm font-semibold">{s.standard}</div>
              <p class="mt-2 text-xs text-slate-400 leading-relaxed">{s.desc}</p>
            </div>
          );
        })}
      </div>
    </div>

  </div>
</section>
